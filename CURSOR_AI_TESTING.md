# Cursor AI 集成 - 测试指南

## ✅ Cursor AI 功能已实现！

恭喜！Cursor AI 集成功能已经完成并可以测试了。

---

## 🎯 实现的功能

### 1. **自动环境检测** ✨
- ✅ 自动识别 Cursor 编辑器
- ✅ 查找可用的 Cursor Chat 命令
- ✅ 智能降级到手动模式

### 2. **半自动化 AI 交互** ✨
- ✅ 自动生成代码审查 Prompt
- ✅ 复制 Prompt 到剪贴板
- ✅ 引导用户使用 Cursor Chat
- ✅ 从剪贴板读取 AI 回复

### 3. **专业的代码审查 Prompt** ✨
- ✅ 针对 C++ 和 Go 优化
- ✅ 关注内存安全、并发问题
- ✅ 检查最佳实践
- ✅ 按严重程度分类输出

### 4. **完整的分析流程** ✨
- ✅ 集成到提交拦截器
- ✅ 显示分析结果
- ✅ 在新标签页展示 Markdown 报告
- ✅ 分析摘要通知

---

## 🧪 如何测试

### 准备工作

1. **确保在 Cursor 中打开项目**
   ```bash
   cd /data/home/danahuang/svn-commit-ai-check
   cursor .
   ```

2. **启动调试**
   - 按 `F5` 启动扩展开发主机

3. **准备 SVN 仓库**
   - 在扩展主机中打开一个 SVN 目录
   - 修改一些 C++ 或 Go 文件

---

### 测试流程

#### Step 1: 触发分析
在扩展主机窗口中：
1. 按 `Ctrl/Cmd + Shift + P`
2. 输入 `SVN: Analyze Changes with AI`
3. 回车执行

#### Step 2: 确认分析
看到对话框：
```
🤖 是否需要 AI 智能分析本次提交的代码？
```
**→ 点击 "OK"**

#### Step 3: 等待 Cursor AI 初始化
会看到进度通知：
```
🤖 AI Code Analysis
⚙️ Initializing AI service...
```

#### Step 4: 使用 Cursor Chat（关键步骤！）

##### 场景 A：如果 Cursor 命令可用（自动）
会看到对话框：
```
📋 代码分析 Prompt 已复制到剪贴板！

请在 Cursor Chat 中粘贴（Ctrl/Cmd+V）并发送。

分析完成后，请手动复制 AI 的回复，然后点击"完成"。

[✅ 已完成分析] [❌ 取消]
```

**操作步骤**：
1. Cursor Chat 应该已自动打开
2. 在 Chat 中按 `Ctrl/Cmd + V` 粘贴 Prompt
3. 按 `Enter` 发送给 AI
4. 等待 AI 分析完成
5. **选中 AI 的完整回复，复制（Ctrl/Cmd + C）**
6. 点击对话框的 "✅ 已完成分析"

##### 场景 B：手动模式（Fallback）
如果自动打开失败，会看到详细指引：
```
📋 代码分析 Prompt 已复制到剪贴板！

请按以下步骤操作：

1️⃣ 按 Ctrl/Cmd + L 打开 Cursor Chat
2️⃣ 粘贴 Prompt（Ctrl/Cmd + V）
3️⃣ 发送给 AI 进行分析
4️⃣ 等待 AI 回复完成
5️⃣ 复制 AI 的完整回复
6️⃣ 点击下面的"已完成分析"按钮

[✅ 已完成分析] [🔄 重新复制 Prompt] [❌ 取消]
```

**操作步骤**：
1. 按 `Ctrl/Cmd + L` 打开 Cursor Chat
2. 按 `Ctrl/Cmd + V` 粘贴 Prompt
3. 按 `Enter` 发送
4. 等待 AI 回复
5. **选中 AI 的完整回复，复制**
6. 点击 "✅ 已完成分析"

#### Step 5: 查看分析结果 ✨

成功后会：
1. **自动打开新标签页**，显示 AI 的完整分析报告（Markdown 格式）
2. **弹出通知**，显示分析摘要：
   ```
   ✅ AI 分析完成 (CURSOR)：发现 3 个问题：Critical: 1 High: 2
   ```

#### Step 6: 决定是否提交

看到最终确认对话框：
```
📊 分析完成，是否继续提交？

发现 3 个问题：Critical: 1 High: 2

[✅ Continue Commit] [❌ Cancel Commit] [📄 查看完整报告]
```

**选项**：
- **Continue Commit**: 忽略问题，继续提交
- **Cancel Commit**: 取消提交，先修复问题
- **查看完整报告**: 再次查看分析报告

---

## 📊 分析报告示例

AI 的分析报告会按以下格式显示：

```markdown
### 🔴 Critical: Memory Leak in src/main.cpp:45
**描述**: 动态分配的内存未释放，可能导致内存泄漏
**建议**: 使用智能指针 std::unique_ptr 或 std::shared_ptr

### 🟠 High: Race Condition in src/thread.go:78
**描述**: 多个 goroutine 同时访问共享变量，未加锁保护
**建议**: 使用 sync.Mutex 或 channel 来同步访问

### 🟡 Medium: Magic Number in src/config.cpp:23
**描述**: 硬编码的数字 100，应定义为常量
**建议**: 
\`\`\`cpp
const int MAX_BUFFER_SIZE = 100;
\`\`\`

### 🟢 Low: Missing Comment in src/utils.go:56
**描述**: 导出的函数缺少文档注释
**建议**: 添加 Godoc 格式的注释
```

---

## 🎨 UI 流程预览

```
触发命令
    ↓
确认对话框 [OK]
    ↓
初始化 AI 服务
    ↓
┌────────────────────────────────────────┐
│ 📋 Prompt 已复制到剪贴板               │
│                                         │
│ 请在 Cursor Chat 中粘贴并发送          │
│                                         │
│ [✅ 已完成分析] [❌ 取消]               │
└────────────────────────────────────────┘
    ↓
用户在 Cursor Chat 中操作
    ↓
用户复制 AI 回复并点击"已完成"
    ↓
┌────────────────────────────────────────┐
│ ✅ 自动打开新标签页                     │
│ 显示 Markdown 格式的分析报告            │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│ 通知：AI 分析完成                       │
│ 发现 X 个问题：Critical: X High: X     │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│ 📊 分析完成，是否继续提交？             │
│                                         │
│ 发现 X 个问题...                        │
│                                         │
│ [Continue] [Cancel] [查看完整报告]      │
└────────────────────────────────────────┘
```

---

## 🔍 测试场景

### 场景 1：正常流程（推荐先测）
1. 修改一个 C++ 文件，故意引入问题（如内存泄漏）
2. 运行分析命令
3. 在 Cursor Chat 中完成分析
4. 查看报告
5. 决定是否提交

### 场景 2：无问题代码
1. 修改文件但不引入问题
2. 运行分析
3. 应该看到 "✅ 未发现明显问题"

### 场景 3：取消分析
1. 在第一个对话框点击 Cancel
2. 验证流程正确终止

### 场景 4：中途取消
1. 开始分析后，在 Cursor Chat 对话框点击"取消"
2. 验证错误处理

### 场景 5：多文件分析
1. 修改多个 C++/Go 文件
2. 验证 Prompt 包含所有文件
3. 验证报告完整

---

## 💡 重要提示

### ✅ DO（推荐操作）
- ✅ 确保复制 AI 的**完整回复**
- ✅ 仔细阅读分析报告
- ✅ 根据严重程度决定是否修复
- ✅ 查看日志了解详细过程（Output → SVN-AI-Check）

### ❌ DON'T（避免操作）
- ❌ 不要只复制部分 AI 回复
- ❌ 不要在 AI 回复未完成时复制
- ❌ 不要忽略 Critical 和 High 级别的问题

---

## 🐛 故障排除

### 问题 1：Prompt 太长，复制失败
**解决**：
- 配置项中减小 `analysis.maxFileSize`
- 或者一次只分析部分文件

### 问题 2：AI 回复不完整
**解决**：
- 等待 Cursor Chat 中 AI 完全回复完毕
- 确保选中并复制了所有内容

### 问题 3：剪贴板内容不对
**解决**：
- 点击 "🔄 重新复制 Prompt" 按钮
- 重新开始流程

### 问题 4：找不到 Cursor Chat
**解决**：
- 手动按 `Ctrl/Cmd + L` 打开
- 或查看 Cursor 菜单栏的 AI Chat 选项

---

## 📈 性能考虑

- **Prompt 长度**: 自动截断超长文件（5000 字符）
- **Token 优化**: 优先发送 diff，完整文件作为上下文
- **文件过滤**: 只分析 C++/Go 文件
- **大小限制**: 默认忽略超过 100KB 的文件

---

## 🎓 Prompt 技巧

### 默认 Prompt 包含
- ✅ C++ 内存安全检查
- ✅ Go 并发问题检查
- ✅ 代码规范检查
- ✅ 安全漏洞检查
- ✅ 最佳实践检查

### 自定义 Prompt
可以在设置中配置：
```json
{
  "svn-commit-ai-check.prompt.system": "你的自定义 Prompt..."
}
```

---

## ✅ 成功标准

测试成功的标志：
- ✅ 能够正确生成 Prompt
- ✅ Prompt 成功复制到剪贴板
- ✅ 能够在 Cursor Chat 中分析
- ✅ AI 回复正确读取
- ✅ 分析报告正确显示
- ✅ 摘要信息准确

---

## 🚀 下一步

完成测试后，可以：
1. 根据测试反馈调整 Prompt
2. 优化 UI 提示文字
3. 添加更多语言支持
4. 实现外部 AI API 集成（DeepSeek/Claude）

---

**文档版本**: v1.0  
**最后更新**: 2026-01-15  
**状态**: ✅ 可以测试 Cursor AI 集成！
